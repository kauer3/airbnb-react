{"version":3,"sources":["../../../src/components/static-map.js"],"names":["React","useState","useRef","useContext","useImperativeHandle","forwardRef","PropTypes","WebMercatorViewport","ResizeObserver","Mapbox","mapboxgl","checkVisibilityConstraints","MAPBOX_LIMITS","MapContext","MapContextProvider","useIsomorphicLayoutEffect","TOKEN_DOC_URL","NO_TOKEN_WARNING","noop","UNAUTHORIZED_ERROR_CODE","CONTAINER_STYLE","position","width","height","overflow","propTypes","Object","assign","oneOfType","number","string","onResize","func","disableTokenWarning","bool","visible","className","style","object","visibilityConstraints","defaultProps","NoTokenWarning","left","top","getRefHandles","mapboxRef","getMap","current","queryRenderedFeatures","geometry","options","map","preventScroll","event","target","scrollTo","StaticMap","props","ref","accessTokenValid","setTokenState","size","setSize","mapDivRef","containerRef","context","supported","undefined","mapbox","container","onError","evt","statusCode","error","status","console","setMap","resizeObserver","entries","contentRect","observe","finalize","disconnect","setProps","overlays","viewport","viewState","children","mapContainerStyle","mapStyle","visibility"],"mappings":";;;;;;;AAmBA,OAAO,KAAKA,KAAZ,MAAuB,OAAvB;AACA,SAAQC,QAAR,EAAkBC,MAAlB,EAA0BC,UAA1B,EAAsCC,mBAAtC,EAA2DC,UAA3D,QAA4E,OAA5E;AACA,OAAO,KAAKC,SAAZ,MAA2B,YAA3B;AAEA,OAAOC,mBAAP,MAAgC,2BAAhC;AACA,OAAOC,cAAP,MAA2B,0BAA3B;AAEA,OAAOC,MAAP,MAAmB,kBAAnB;AACA,OAAOC,QAAP,MAAqB,mBAArB;AACA,SAAQC,0BAAR,QAAyC,0BAAzC;AACA,SAAQC,aAAR,QAA4B,oBAA5B;AACA,OAAOC,UAAP,IAAoBC,kBAApB,QAA6C,eAA7C;AACA,OAAOC,yBAAP,MAAsC,uCAAtC;AAGA,IAAMC,aAAa,GAAG,qEAAtB;AACA,IAAMC,gBAAgB,GAAG,yDAAzB;;AAGA,SAASC,IAAT,GAAgB,CAAE;;AAElB,IAAMC,uBAAuB,GAAG,GAAhC;AAEA,IAAMC,eAAe,GAAG;AACtBC,EAAAA,QAAQ,EAAE,UADY;AAEtBC,EAAAA,KAAK,EAAE,MAFe;AAGtBC,EAAAA,MAAM,EAAE,MAHc;AAItBC,EAAAA,QAAQ,EAAE;AAJY,CAAxB;AAOA,IAAMC,SAAS,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBlB,MAAM,CAACgB,SAAzB,EAAoC;AAEpDH,EAAAA,KAAK,EAAEhB,SAAS,CAACsB,SAAV,CAAoB,CAACtB,SAAS,CAACuB,MAAX,EAAmBvB,SAAS,CAACwB,MAA7B,CAApB,CAF6C;AAGpDP,EAAAA,MAAM,EAAEjB,SAAS,CAACsB,SAAV,CAAoB,CAACtB,SAAS,CAACuB,MAAX,EAAmBvB,SAAS,CAACwB,MAA7B,CAApB,CAH4C;AAMpDC,EAAAA,QAAQ,EAAEzB,SAAS,CAAC0B,IANgC;AAQpDC,EAAAA,mBAAmB,EAAE3B,SAAS,CAAC4B,IARqB;AAUpDC,EAAAA,OAAO,EAAE7B,SAAS,CAAC4B,IAViC;AAYpDE,EAAAA,SAAS,EAAE9B,SAAS,CAACwB,MAZ+B;AAcpDO,EAAAA,KAAK,EAAE/B,SAAS,CAACgC,MAdmC;AAmBpDC,EAAAA,qBAAqB,EAAEjC,SAAS,CAACgC;AAnBmB,CAApC,CAAlB;AAsBA,IAAME,YAAY,GAAGd,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBlB,MAAM,CAAC+B,YAAzB,EAAuC;AAC1DP,EAAAA,mBAAmB,EAAE,KADqC;AAE1DE,EAAAA,OAAO,EAAE,IAFiD;AAG1DJ,EAAAA,QAAQ,EAAEb,IAHgD;AAI1DkB,EAAAA,SAAS,EAAE,EAJ+C;AAK1DC,EAAAA,KAAK,EAAE,IALmD;AAM1DE,EAAAA,qBAAqB,EAAE3B;AANmC,CAAvC,CAArB;;AASA,SAAS6B,cAAT,GAA0B;AACxB,MAAMJ,KAAK,GAAG;AACZhB,IAAAA,QAAQ,EAAE,UADE;AAEZqB,IAAAA,IAAI,EAAE,CAFM;AAGZC,IAAAA,GAAG,EAAE;AAHO,GAAd;AAKA,SACE;AACE,IAAA,GAAG,EAAC,SADN;AAEE,IAAA,EAAE,EAAC,kBAFL;AAIE,IAAA,KAAK,EAAEN;AAJT,KAME;AAAI,IAAA,GAAG,EAAC;AAAR,KAAkBpB,gBAAlB,CANF,EAOE;AAAK,IAAA,GAAG,EAAC;AAAT,wDAPF,EAQE;AAAG,IAAA,GAAG,EAAC,MAAP;AAAc,IAAA,IAAI,EAAED;AAApB,0BARF,CADF;AAcD;;AAED,SAAS4B,aAAT,CAAuBC,SAAvB,EAAkC;AAChC,SAAO;AACLC,IAAAA,MAAM,EAAE;AAAA,aAAMD,SAAS,CAACE,OAAV,IAAqBF,SAAS,CAACE,OAAV,CAAkBD,MAAlB,EAA3B;AAAA,KADH;AAELE,IAAAA,qBAAqB,EAAE,+BAACC,QAAD,EAA4B;AAAA,UAAjBC,OAAiB,uEAAP,EAAO;AACjD,UAAMC,GAAG,GAAGN,SAAS,CAACE,OAAV,IAAqBF,SAAS,CAACE,OAAV,CAAkBD,MAAlB,EAAjC;AACA,aAAOK,GAAG,IAAIA,GAAG,CAACH,qBAAJ,CAA0BC,QAA1B,EAAoCC,OAApC,CAAd;AACD;AALI,GAAP;AAOD;;AAED,SAASE,aAAT,CAAuBC,KAAvB,EAA8B;AAC5BA,EAAAA,KAAK,CAACC,MAAN,CAAaC,QAAb,CAAsB,CAAtB,EAAyB,CAAzB;AACD;;AAED,IAAMC,SAAS,GAAGnD,UAAU,CAAC,UAACoD,KAAD,EAAQC,GAAR,EAAgB;AAAA,kBACDzD,QAAQ,CAAC,IAAD,CADP;AAAA;AAAA,MACpC0D,gBADoC;AAAA,MAClBC,aADkB;;AAAA,mBAEnB3D,QAAQ,CAAC,CAAC,CAAD,EAAI,CAAJ,CAAD,CAFW;AAAA;AAAA,MAEpC4D,IAFoC;AAAA,MAE9BC,OAF8B;;AAG3C,MAAMjB,SAAS,GAAG3C,MAAM,CAAC,IAAD,CAAxB;AACA,MAAM6D,SAAS,GAAG7D,MAAM,CAAC,IAAD,CAAxB;AACA,MAAM8D,YAAY,GAAG9D,MAAM,CAAC,IAAD,CAA3B;AACA,MAAM+D,OAAO,GAAG9D,UAAU,CAACU,UAAD,CAA1B;AAEAE,EAAAA,yBAAyB,CAAC,YAAM;AAC9B,QAAI,CAACyC,SAAS,CAACU,SAAV,EAAL,EAA4B;AAC1B,aAAOC,SAAP;AACD;;AAGD,QAAMC,MAAM,GAAG,IAAI3D,MAAJ,iCACVgD,KADU;AAEb/C,MAAAA,QAAQ,EAARA,QAFa;AAGbY,MAAAA,KAAK,EAAEuC,IAAI,CAAC,CAAD,CAHE;AAIbtC,MAAAA,MAAM,EAAEsC,IAAI,CAAC,CAAD,CAJC;AAKbQ,MAAAA,SAAS,EAAEN,SAAS,CAAChB,OALR;AAMbuB,MAAAA,OAAO,EAAE,iBAAAC,GAAG,EAAI;AACd,YAAMC,UAAU,GAAID,GAAG,CAACE,KAAJ,IAAaF,GAAG,CAACE,KAAJ,CAAUC,MAAxB,IAAmCH,GAAG,CAACG,MAA1D;;AACA,YAAIF,UAAU,KAAKrD,uBAAf,IAA0CwC,gBAA9C,EAAgE;AAE9DgB,UAAAA,OAAO,CAACF,KAAR,CAAcxD,gBAAd;AACA2C,UAAAA,aAAa,CAAC,KAAD,CAAb;AACD;;AACDH,QAAAA,KAAK,CAACa,OAAN,CAAcC,GAAd;AACD;AAdY,OAAf;AAgBA1B,IAAAA,SAAS,CAACE,OAAV,GAAoBqB,MAApB;;AAEA,QAAIH,OAAO,IAAIA,OAAO,CAACW,MAAvB,EAA+B;AAC7BX,MAAAA,OAAO,CAACW,MAAR,CAAeR,MAAM,CAACtB,MAAP,EAAf;AACD;;AAED,QAAM+B,cAAc,GAAG,IAAIrE,cAAJ,CAAmB,UAAAsE,OAAO,EAAI;AACnD,UAAIA,OAAO,CAAC,CAAD,CAAP,CAAWC,WAAf,EAA4B;AAAA,oCACFD,OAAO,CAAC,CAAD,CAAP,CAAWC,WADT;AAAA,YACnBzD,MADmB,yBACnBA,KADmB;AAAA,YACZC,OADY,yBACZA,MADY;AAE1BuC,QAAAA,OAAO,CAAC,CAACxC,MAAD,EAAQC,OAAR,CAAD,CAAP;AACAkC,QAAAA,KAAK,CAAC1B,QAAN,CAAe;AAACT,UAAAA,KAAK,EAALA,MAAD;AAAQC,UAAAA,MAAM,EAANA;AAAR,SAAf;AACD;AACF,KANsB,CAAvB;AAOAsD,IAAAA,cAAc,CAACG,OAAf,CAAuBhB,YAAY,CAACjB,OAApC;AAGA,WAAO,YAAM;AACXqB,MAAAA,MAAM,CAACa,QAAP;AACApC,MAAAA,SAAS,CAACE,OAAV,GAAoB,IAApB;AACA8B,MAAAA,cAAc,CAACK,UAAf;AACD,KAJD;AAKD,GA3CwB,EA2CtB,EA3CsB,CAAzB;AA6CAnE,EAAAA,yBAAyB,CAAC,YAAM;AAC9B,QAAI8B,SAAS,CAACE,OAAd,EAAuB;AACrBF,MAAAA,SAAS,CAACE,OAAV,CAAkBoC,QAAlB,CACEzD,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB8B,KAAlB,EAAyB;AACvBnC,QAAAA,KAAK,EAAEuC,IAAI,CAAC,CAAD,CADY;AAEvBtC,QAAAA,MAAM,EAAEsC,IAAI,CAAC,CAAD;AAFW,OAAzB,CADF;AAMD;AACF,GATwB,CAAzB;AAWA,MAAMV,GAAG,GAAGN,SAAS,CAACE,OAAV,IAAqBF,SAAS,CAACE,OAAV,CAAkBD,MAAlB,EAAjC;AAIA1C,EAAAA,mBAAmB,CAACsD,GAAD,EAAM;AAAA,WAAMd,aAAa,CAACC,SAAD,CAAnB;AAAA,GAAN,EAAsC,EAAtC,CAAnB;AAEA,MAAMuC,QAAQ,GAAGjC,GAAG,IAClB,oBAAC,kBAAD;AACE,IAAA,KAAK,kCACAc,OADA;AAEHoB,MAAAA,QAAQ,EACNpB,OAAO,CAACoB,QAAR,IACA,IAAI9E,mBAAJ,+CACKkD,KADL,GAEKA,KAAK,CAAC6B,SAFX;AAGEhE,QAAAA,KAAK,EAAEuC,IAAI,CAAC,CAAD,CAHb;AAIEtC,QAAAA,MAAM,EAAEsC,IAAI,CAAC,CAAD;AAJd,SAJC;AAUHV,MAAAA,GAAG,EAAHA,GAVG;AAWHkB,MAAAA,SAAS,EAAEJ,OAAO,CAACI,SAAR,IAAqBL,YAAY,CAACjB;AAX1C;AADP,KAeE;AACE,IAAA,GAAG,EAAC,cADN;AAEE,IAAA,SAAS,EAAC,UAFZ;AAIE,IAAA,KAAK,EAAE3B,eAJT;AAKE,IAAA,QAAQ,EAAEgC;AALZ,KAOGK,KAAK,CAAC8B,QAPT,CAfF,CADF;AAtE2C,MAkGpCnD,SAlGoC,GAkGsBqB,KAlGtB,CAkGpCrB,SAlGoC;AAAA,MAkGzBd,KAlGyB,GAkGsBmC,KAlGtB,CAkGzBnC,KAlGyB;AAAA,MAkGlBC,MAlGkB,GAkGsBkC,KAlGtB,CAkGlBlC,MAlGkB;AAAA,MAkGVc,KAlGU,GAkGsBoB,KAlGtB,CAkGVpB,KAlGU;AAAA,MAkGHE,qBAlGG,GAkGsBkB,KAlGtB,CAkGHlB,qBAlGG;AAmG3C,MAAMiD,iBAAiB,GAAG9D,MAAM,CAACC,MAAP,CAAc;AAACN,IAAAA,QAAQ,EAAE;AAAX,GAAd,EAAsCgB,KAAtC,EAA6C;AACrEf,IAAAA,KAAK,EAALA,KADqE;AAErEC,IAAAA,MAAM,EAANA;AAFqE,GAA7C,CAA1B;AAKA,MAAMY,OAAO,GACXsB,KAAK,CAACtB,OAAN,IAAiBxB,0BAA0B,CAAC8C,KAAK,CAAC6B,SAAN,IAAmB7B,KAApB,EAA2BlB,qBAA3B,CAD7C;AAGA,MAAMkD,QAAQ,GAAG/D,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBP,eAAlB,EAAmC;AAClDsE,IAAAA,UAAU,EAAEvD,OAAO,GAAG,SAAH,GAAe;AADgB,GAAnC,CAAjB;AAIA,SACE;AACE,IAAA,GAAG,EAAC,eADN;AAEE,IAAA,GAAG,EAAE6B,YAFP;AAIE,IAAA,KAAK,EAAEwB;AAJT,KAME;AACE,IAAA,GAAG,EAAC,YADN;AAEE,IAAA,GAAG,EAAEzB,SAFP;AAIE,IAAA,KAAK,EAAE0B,QAJT;AAKE,IAAA,SAAS,EAAErD;AALb,IANF,EAaGgD,QAbH,EAcG,CAACzB,gBAAD,IAAqB,CAACF,KAAK,CAACxB,mBAA5B,IAAmD,oBAAC,cAAD,OAdtD,CADF;AAkBD,CAjI2B,CAA5B;;AAmIAuB,SAAS,CAACU,SAAV,GAAsB;AAAA,SAAMxD,QAAQ,IAAIA,QAAQ,CAACwD,SAAT,EAAlB;AAAA,CAAtB;;AACAV,SAAS,CAAC/B,SAAV,GAAsBA,SAAtB;AACA+B,SAAS,CAAChB,YAAV,GAAyBA,YAAzB;AAEA,eAAegB,SAAf","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as React from 'react';\nimport {useState, useRef, useContext, useImperativeHandle, forwardRef} from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport WebMercatorViewport from 'viewport-mercator-project';\nimport ResizeObserver from 'resize-observer-polyfill';\n\nimport Mapbox from '../mapbox/mapbox';\nimport mapboxgl from '../utils/mapboxgl';\nimport {checkVisibilityConstraints} from '../utils/map-constraints';\nimport {MAPBOX_LIMITS} from '../utils/map-state';\nimport MapContext, {MapContextProvider} from './map-context';\nimport useIsomorphicLayoutEffect from '../utils/use-isomorphic-layout-effect';\n\n/* eslint-disable max-len */\nconst TOKEN_DOC_URL = 'https://visgl.github.io/react-map-gl/docs/get-started/mapbox-tokens';\nconst NO_TOKEN_WARNING = 'A valid API access token is required to use Mapbox data';\n/* eslint-disable max-len */\n\nfunction noop() {}\n\nconst UNAUTHORIZED_ERROR_CODE = 401;\n\nconst CONTAINER_STYLE = {\n  position: 'absolute',\n  width: '100%',\n  height: '100%',\n  overflow: 'hidden'\n};\n\nconst propTypes = Object.assign({}, Mapbox.propTypes, {\n  /** The dimensions of the map **/\n  width: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n\n  /** Callback when map size changes **/\n  onResize: PropTypes.func,\n  /** Hide invalid token warning even if request fails */\n  disableTokenWarning: PropTypes.bool,\n  /** Whether the map is visible */\n  visible: PropTypes.bool,\n  /** Custom class name for the map */\n  className: PropTypes.string,\n  /** Custom CSS for the container */\n  style: PropTypes.object,\n\n  /** Advanced features */\n  // Contraints for displaying the map. If not met, then the map is hidden.\n  // Experimental! May be changed in minor version updates.\n  visibilityConstraints: PropTypes.object\n});\n\nconst defaultProps = Object.assign({}, Mapbox.defaultProps, {\n  disableTokenWarning: false,\n  visible: true,\n  onResize: noop,\n  className: '',\n  style: null,\n  visibilityConstraints: MAPBOX_LIMITS\n});\n\nfunction NoTokenWarning() {\n  const style = {\n    position: 'absolute',\n    left: 0,\n    top: 0\n  };\n  return (\n    <div\n      key=\"warning\"\n      id=\"no-token-warning\"\n      // @ts-ignore\n      style={style}\n    >\n      <h3 key=\"header\">{NO_TOKEN_WARNING}</h3>\n      <div key=\"text\">For information on setting up your basemap, read</div>\n      <a key=\"link\" href={TOKEN_DOC_URL}>\n        Note on Map Tokens\n      </a>\n    </div>\n  );\n}\n\nfunction getRefHandles(mapboxRef) {\n  return {\n    getMap: () => mapboxRef.current && mapboxRef.current.getMap(),\n    queryRenderedFeatures: (geometry, options = {}) => {\n      const map = mapboxRef.current && mapboxRef.current.getMap();\n      return map && map.queryRenderedFeatures(geometry, options);\n    }\n  };\n}\n\nfunction preventScroll(event) {\n  event.target.scrollTo(0, 0);\n}\n\nconst StaticMap = forwardRef((props, ref) => {\n  const [accessTokenValid, setTokenState] = useState(true);\n  const [size, setSize] = useState([0, 0]);\n  const mapboxRef = useRef(null);\n  const mapDivRef = useRef(null);\n  const containerRef = useRef(null);\n  const context = useContext(MapContext);\n\n  useIsomorphicLayoutEffect(() => {\n    if (!StaticMap.supported()) {\n      return undefined;\n    }\n\n    // Initialize\n    const mapbox = new Mapbox({\n      ...props,\n      mapboxgl, // Handle to mapbox-gl library\n      width: size[0],\n      height: size[1],\n      container: mapDivRef.current,\n      onError: evt => {\n        const statusCode = (evt.error && evt.error.status) || evt.status;\n        if (statusCode === UNAUTHORIZED_ERROR_CODE && accessTokenValid) {\n          // Mapbox throws unauthorized error - invalid token\n          console.error(NO_TOKEN_WARNING); // eslint-disable-line\n          setTokenState(false);\n        }\n        props.onError(evt);\n      }\n    });\n    mapboxRef.current = mapbox;\n\n    if (context && context.setMap) {\n      context.setMap(mapbox.getMap());\n    }\n\n    const resizeObserver = new ResizeObserver(entries => {\n      if (entries[0].contentRect) {\n        const {width, height} = entries[0].contentRect;\n        setSize([width, height]);\n        props.onResize({width, height});\n      }\n    });\n    resizeObserver.observe(containerRef.current);\n\n    // Clean up\n    return () => {\n      mapbox.finalize();\n      mapboxRef.current = null;\n      resizeObserver.disconnect();\n    };\n  }, []);\n\n  useIsomorphicLayoutEffect(() => {\n    if (mapboxRef.current) {\n      mapboxRef.current.setProps(\n        Object.assign({}, props, {\n          width: size[0],\n          height: size[1]\n        })\n      );\n    }\n  });\n\n  const map = mapboxRef.current && mapboxRef.current.getMap();\n\n  // External apps can call methods via ref\n  // Note: this is not a recommended pattern in React FC - Keeping for backward compatibility\n  useImperativeHandle(ref, () => getRefHandles(mapboxRef), []);\n\n  const overlays = map && (\n    <MapContextProvider\n      value={{\n        ...context,\n        viewport:\n          context.viewport ||\n          new WebMercatorViewport({\n            ...props,\n            ...props.viewState,\n            width: size[0],\n            height: size[1]\n          }),\n        map,\n        container: context.container || containerRef.current\n      }}\n    >\n      <div\n        key=\"map-overlays\"\n        className=\"overlays\"\n        // @ts-ignore\n        style={CONTAINER_STYLE}\n        onScroll={preventScroll}\n      >\n        {props.children}\n      </div>\n    </MapContextProvider>\n  );\n\n  const {className, width, height, style, visibilityConstraints} = props;\n  const mapContainerStyle = Object.assign({position: 'relative'}, style, {\n    width,\n    height\n  });\n\n  const visible =\n    props.visible && checkVisibilityConstraints(props.viewState || props, visibilityConstraints);\n\n  const mapStyle = Object.assign({}, CONTAINER_STYLE, {\n    visibility: visible ? 'inherit' : 'hidden'\n  });\n\n  return (\n    <div\n      key=\"map-container\"\n      ref={containerRef}\n      // @ts-ignore\n      style={mapContainerStyle}\n    >\n      <div\n        key=\"map-mapbox\"\n        ref={mapDivRef}\n        // @ts-ignore\n        style={mapStyle}\n        className={className}\n      />\n      {overlays}\n      {!accessTokenValid && !props.disableTokenWarning && <NoTokenWarning />}\n    </div>\n  );\n});\n\nStaticMap.supported = () => mapboxgl && mapboxgl.supported();\nStaticMap.propTypes = propTypes;\nStaticMap.defaultProps = defaultProps;\n\nexport default StaticMap;\n"],"file":"static-map.js"}